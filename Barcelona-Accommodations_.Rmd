---
title: "Machine Learning Methods: Analysing Barcelona Accommodations"
author: "Martina Diaz, Fatima Barcina, Catalina Roth"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true          # Enables the table of contents
    toc_depth: 3       # Control the depth of headers to include in the TOC
    toc_float: true    # Makes the TOC float on the page
  pdf_document:
    toc: true          # Enables the table of contents for PDF output
    toc_depth: 2       # Controls the depth of headers to include in the TOC
  word_document:
    toc: true          # Enables the table of contents for Word output
    toc_depth: 2       # Controls the depth of headers to include in the TOC
editor_options: 
  chunk_output_type: html
always_allow_html: true
runtime: shiny
---

```{r download packages, include = FALSE}
options(repos = c(CRAN = "https://cran.rstudio.com/"))
#file.edit("~/.Rprofile")
```

```{r setup!, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#options(repos = c(CRAN = "https://cran.rstudio.com/"))
```

```{r pressure., echo=FALSE, warning=FALSE, out.width='60%', fig.align='center', fig.cap="Barcelona's Digital Landscape: a data-driven exploration of urban dynamics around Sagrada Familia. AI-generated by our team."}
knitr::include_graphics("Barcelona Picture.png")
```

```{r Packages, include=FALSE}
# Instal requiered packages
install.packages(c("dplyr", "ggplot2", "tidyr", "RColorBrewer", "leaflet", "shiny", "leaflet.extras", "corrplot", "treemap", "wordcloud", "mgcv", "gratia", "rsample", "Metrics", "forcats", "VGAM", "e1071"))
```

```{r libraries, include=FALSE}
# Load required libraries
library(dplyr)        # Data manipulation and wrangling
library(ggplot2)      # Data visualization
library(tidyr)        # Data tidying
library(RColorBrewer) # Color palettes for visualizations
library(leaflet)      # Interactive maps
library(shiny)        # Building interactive web applications
library(leaflet.extras) # Additional features for leaflet maps
library(corrplot)     # Visualization of correlation matrices
library(mice)         # Handling missing data
library(nnet)         # Multinomial regression model
library(forcats)      # Handling categorical variables
library(patchwork)    # Combining multiple ggplots
library(VGAM)         # Multinomial logistic regression models
library(tidyverse)    # Collection of data science packages
library(e1071)        # Support Vector Machines (SVM)
library(reshape2)     # Data reshaping for ggplot visualizations
library(caret)        # Machine learning and model evaluation
library(wordcloud)    # Wordcloud plot
library(rsample)      # Split dataset into training and testing
library(mgcv)         # Gam Mdels
```

# 1. Introduction

## 1.1 Presentation of the case

A tourism company based in Zürich, Switzerland, has observed a significant increase in travel demand to Barcelona in recent years. Indeed, Barcelona ranks as the third most in-demand city for Airbnb rentals in Europe, behind Paris and London.

Consequently, the company’s manager has requested a Machine Learning study and analysis of Airbnb accommodations in the city. The goal is to understand price behavior and identify the factors influencing accommodation costs and occupancy, enabling the company to provide optimal responses to clients' inquiries.

To achieve this goal, the team has decided to analyse and address three question to provide comprehensive insights for the manager.

1. **What are the key factors influencing accommodation prices in Barcelona?**
2. **Can we predict occupancy rates based on location, amenities, or other factors?**
3. **How accurately can machine learning predict Airbnb prices in Barcelona? Which models perform best for this dataset?**

## 1.2 Motivations
Barcelona is one of the most visited cities in Europe, and the rise of Airbnb and other short-term rental platforms has led to a notable increase in tourism. However, this growth also presents challenges for accommodation businesses and the local housing market. A study conducted by the Social Science Research Network (<span style="color:blue">SSRN, link: https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3428237</span>) revealed that rental costs in neighborhoods with high Airbnb activity increased by 7% between 2009 and 2016. This is primarily due to the fact that property owners, motivated by the demand from tourists seeking short-term rentals, frequently opt to lease their properties at higher rates during the short term rather than committing to long-term leases.

For these reasons, it is crucial for tourism companies to understand this dynamic market to remain competitive and provide tailored services to their clients.

The Zürich-based tourism company needs reliable data on Airbnb prices and occupancy rates to make data-driven recommendations and stay ahead of competitors.

## 1.3 Disclaimer
This analysis is for educational purposes only. The findings are based on public data and are not professional advice. The results should not be used for business or policy decisions.

## 1.4 Dataset selected

To conduct the study, the team has decided to analyse a dataset of Barcelona Airbnbs available on the Kaggle website (<span style="color:blue">link: https://www.kaggle.com/datasets/fermatsavant/airbnb-dataset-of-barcelona-city</span>)

The dataset consists of 19.833 observations across 25 variables, including geographical zones, amenities, prices, and accommodations.


```{r dataset download, include=FALSE}
# import the dataset
BCN_Accomm_full <- read.csv("Cleaned_airbnb_barcelona.csv")
```

Below, we can see the structure of the dataset, and the names and data types for each column.

```{r Structure dataset, echo = FALSE}
# Structure
glimpse(BCN_Accomm_full)
```

### Numerical values:
- **`X`**: numerical index for rows
- **`id`**: unique identifier for listings
- **`host_id`**: unique identifier for hosts
- **`host_listings_count`**: number of listings by the host
- **`latitude`**: geographic latitude of the listing
- **`longitude`**: geographic longitude of the listing
- **`accommodates`**: number of guests the listing can accommodate
- **`bathrooms`**: number of bathrooms in the listing
- **`bedrooms`**: number of bedrooms in the listing
- **`beds`**: number of beds in the listing
- **`minimum_nights`**: minimum number of nights required for booking
- **`availability_30`**: number of available nights in the next 30 days
- **`availability_60`**: number of available nights in the next 60 days
- **`availability_90`**: number of available nights in the next 90 days
- **`availability_365`**: number of available nights in the next 365 days
- **`number_of_reviews_ltm`**: number of reviews in the last 12 months
- **`review_scores_rating`**: average review rating score

### Binary variables:
- **`host_is_superhost`**: indicates if the host is a superhost (`"t"` or `"f"`)
- **`has_availability`**: indicates if the listing is available for booking (`"t"` or `"f"`)

### String values:
- **`neighbourhood`**: name of the neighbourhood where the listing is located
- **`zipcode`**: postal code of the listing
- **`property_type`**: type of property (e.g., "Apartment")
- **`room_type`**: type of room (e.g., "Entire home/apt")
- **`amenities`**: list of amenities provided in the listing
- **`price`**: price of the listing as a string (e.g., "$130.00")


As can be appreciated, the variable 'price' has a 'Character' data type. Therefore, in the chapter 3, this field will be transformed into an integer variable to enable the necessary calculations.

## 1.5 Sub-sampling

In order to streamline the calculations and analysis, a sub-dataset will be created in the following steps, considering 10.000 observations selected randomly. Additionally, a seed is created to ensure the same observations are maintained throughout the analysis

```{r sub-set, echo=FALSE}
set.seed(100)
BCN_Accomm_sub <- sample_n(BCN_Accomm_full, 10000) 
glimpse(BCN_Accomm_sub)
```

# 2. Methodology

To address the research question, the study will be divided into three parts. First, an Exploratory Data Analysis (EDA) will be conducted to gain a deeper understanding of the data. Second, Machine Learning models will be implemented, and their performance will be evaluated to identify the best-performing model. Finally, the selected model will be used to provide the most accurate answer to the research question posed by the team.

The different models to be developed are: 

1. Linear Model (FB)
2. Generalised Linear Model with family set to Poisson for binary data (FB)
3. Generalised Linear Model with family set to Binomial for binomial and multinomial data (MD)
4. Generalised Additive Model for (CR)
5. Neural Network for (CR)
6. Support Vector Machine for (MD)

# 3 Exploratory Data Analysis

## 3.1 Converting Price variable to numeric

First, the pricing variable will be converted into a numeric format, and in the fifth chapter of this report (Machine Learning Models), the categorical variables will be transformed into factors for further analysis and modeling.

```{r Convert price to numeric}
BCN_Accomm_sub$price <- gsub(",", "", BCN_Accomm_sub$price) # removed ','
BCN_Accomm_sub$price <- gsub("\\$", "", BCN_Accomm_sub$price) # removed '$' sign
BCN_Accomm_sub$price <- as.numeric(BCN_Accomm_sub$price)  # converted to number format
```

## 3.2 Missing values (detect and treat) (MD) 

```{r miss-values, include=FALSE}
print('Location of missing values')
# find location of missing values column wise
sapply(BCN_Accomm_sub, function(x) which(is.na(x)))

```

```{r Count missing values per columns, echo =FALSE}
# count the missing values column wise
sapply(BCN_Accomm_sub, function(x) sum(is.na(x)))
```

```{r patt-miss-values, echo = FALSE}
md.pattern(BCN_Accomm_sub, rotate.names = TRUE)
```

```{r tab-miss-values, echo = FALSE}
# Total observations
total_rows <- nrow(BCN_Accomm_sub) 

# Calculate missing values (count and percentage)
missing_values <- data.frame(
  #Variable = names(BCN_Accomm_full),
  Missing_Count = colSums(is.na(BCN_Accomm_sub)),
  Missing_Percent = paste0(round((colSums(is.na(BCN_Accomm_sub)) / total_rows) * 100, 2), "%"))

# Order DataFrame table in descending order
missing_values <- missing_values[order(-missing_values$Missing_Count), ]

# Display the table
knitr::kable(missing_values, 
             caption = "Missing Values by Variable",
             align = "c")
```

## 3.2.1 How to manage Missing values for each field (MD) 

host_listings_count : since is not possible to make any calculation on the number of listing of the host, we exclude the 22 rows that lack of it.
bathrooms : the number of bathrooms is missing in 6 rows. 
beds : the number of beds is not specified for 18 assets. 
bedrooms : 2 rows contains missing value and can be deleted.
review_scores_rating : the review score rating is missing in 2415 rows of 10000. It's a quite relevant percentage, around the 24% of the data we selected. In this case we decide to impute the missing values replacing it with the value 0.

```{r imputation_review_score_rating, echo = FALSE}
# Create a new data frame with the imputed review_scores_rating column
imp_BCN_Accomm_sub <- BCN_Accomm_sub %>%
  mutate(review_scores_rating = if_else(is.na(review_scores_rating), 0, review_scores_rating))

md.pattern(imp_BCN_Accomm_sub, rotate.names = TRUE)
```

Eventually, the other fields that present missing values do not allow to replace the empty data with estimates (average, mean, ...) so called imputation. This fields include in total 48 assets that represent 0.48% of the total assets and allows to delete the entire rows without loosing too many information.

```{r removing-rows, include = FALSE}
BCN_Accomm <- na.omit(imp_BCN_Accomm_sub) # from this point we'll use this data set
md.pattern(BCN_Accomm, rotate.names = TRUE)
```

## 3.3 Correlation matrix

```{r correlation_matrix_numeric_fields}
# Create a correlation matrix for numeric fields
cor_BNC_Accomm <- select_if(BCN_Accomm, is.numeric) %>%
  select(-c(id, X, host_id))

# make a data frame
cor_BNC_Accomm <- data.frame(cor_BNC_Accomm)
str(cor_BNC_Accomm)

# print correlation matrix
corrplot(cor(cor_BNC_Accomm), type = "upper", order = "hclust", tl.col = "black")
```

From the correlation matrix is possible to deduct the following characteristics:
- there's almost no correlation between availability periods and number of beds, bedrooms, bathrooms. It would suggest that the availability of the house do not depend from those features, rather probably from the location and facilities.
- there is a positive correlation between number of bedrooms, beds and bathrooms.
- there is a positive correlation between the availability periods. 

## 3.4 Outliers (boxplots) (detect and treat) (CR)
Since the price variable is a key focus of our analysis, an outlier analysis of this variable has been conducted.

### 3.4.1 Count of outliers in Price

```{r Outliers for the variable Price, echo = FALSE}
# Calculate Q1, Q3, and IQR for the price variable
Q1 <- quantile(BCN_Accomm$price, 0.25)
Q3 <- quantile(BCN_Accomm$price, 0.75)
IQR <- Q3 - Q1

# Add a column to indicate outliers 
BCN_Accomm_sub_outlier <- BCN_Accomm %>%
  mutate(is_outlier = price < (Q1 - 1.5 * IQR) | price > (Q3 + 1.5 * IQR))

# Count the number of outliers
outliers_count <- sum(BCN_Accomm_sub_outlier$is_outlier)

# Display outliers count
outliers_count

```

Out of a total of 10,000 values, 804 (8.04%) are identified as outliers. Below, a boxplot is presented to visualize the median and the outlier observations.

```{r Boxplot Price, echo= FALSE}
# Boxplot for price variable
boxplot(BCN_Accomm$price, 
        horizontal = TRUE,
        axes = FALSE, 
        staplewex = 1, 
        ylim = c(2, 500),
        main = "Boxplot of Price/Night Variable (€)")  

# X Axis
axis(1, las = 1)

# Add text labels values (Q1, Q3, IQR)
stats <- boxplot.stats(BCN_Accomm$price)$stats
text(x = stats, y = 1.25, labels = stats, pos = 3, cex = 0.9) 
```

From the boxplot above, it can be concluded that the median price is approximately 65€ per night, with 50% of the observations concentrated between 40€ (25th percentile) and 112€ (75th percentile), representing the interquartile range (IQR).

Additionally, the presence of numerous outliers extending to the right indicates a right-skewed distribution, meaning higher prices are influencing the dataset.

The significant number of observations with higher prices could suggest the presence of many luxury properties. Therefore, further analysis is required to identify the factors influencing these price variations.

### 3.4.2 Detecting Top 20 Price Outliers

```{r Filter outliers, echo = FALSE}
# Filter rows Outliers
outlier_extremes <- BCN_Accomm_sub_outlier%>%
  filter(is_outlier == TRUE) %>%
  select(neighbourhood, property_type, bedrooms, price) %>%
  arrange(desc(price), neighbourhood, property_type) %>%
  slice_head(n = 20)  # Select top 20 Outliers for price

# Display Prices outliers
knitr::kable(outlier_extremes, 
             caption = "Table 2: Top 20 and Outliers for Price Variable with Neighbourhood",
             align = "c")
```

It seems that the price variable may contain erroneous entries. For further analysis, research revealed that the average nightly rate for an Airbnb in Barcelona is €93 (according to <span style="color:blue">Hostel Geeks, link: https://hostelgeeks.com/best-airbnbs-in-barcelona-spain/</span>). Therefore, prices of €8,000 are likely errors. As a result, it was decided to exclude prices above €1,000 from the analysis.

The new summary for tha Price variable is the following:

```{r Filter price lesss than 1000, echo=FALSE}
# Filter dataset
BCN_Accomm <- BCN_Accomm %>%
  filter(price <= 1000)

summary(BCN_Accomm$price)
```

Now, a new Correlation Matrix with the filtered observations of the price variable is displayed.

```{r New correlation_matrix_numeric_fields, echo = FALSE}
# Create a correlation matrix for numeric fields
cor_BNC_Accomm_new <- select_if(BCN_Accomm, is.numeric) %>%
  select(-c(id, X, host_id))

# make a data frame
cor_BNC_Accomm_new <- data.frame(cor_BNC_Accomm_new)
str(cor_BNC_Accomm)

# print correlation matrix
corrplot(cor(cor_BNC_Accomm_new), type = "upper", order = "hclust", tl.col = "black")
```

We can observe that the price variable is now most correlated with variables related to the size and capacity of an Airbnb, such as bathrooms, bedrooms, number of beds, and accommodates.

On the other hand, general availability and review scores have little impact on the price.

### 3.5 Histograms for Numerical Variables(CR)

```{r Histograms Numerical Variables, echo=FALSE, warning=FALSE}

# Reshape the data set to long format
BCN_Accomm_hist <- BCN_Accomm %>%
  pivot_longer(cols = c(price,
                        accommodates,
                        bathrooms,
                        bedrooms,
                        beds,
                        minimum_nights,
                        number_of_reviews_ltm,
                        review_scores_rating
),  
               names_to = "variable", values_to = "value")

# Create histograms with facet_wrap
hist_num <- ggplot(BCN_Accomm_hist, aes(x = value)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black") +  
  labs(title = "Histograms for Numerical Variables", x = "Value", y = "Frequency") +
  facet_wrap(~variable, scales = "free") +  # each plot with their own y axes
  theme_minimal()

print(hist_num)
```

From the histograms above, several variables exhibit right-skewed distributions, including price, minimum_nights, and number_of_reviews_ltm.

On the other hand, the data suggests that in Barcelona, Airbnb listings are primarily designed for small groups of people seeking short-term stays. Additionally, these accommodations tend to receive high review scores, indicating good guest satisfaction with the different properties.

### 3.4 Pie Charts for Binary Variable "Host_is_superhost"

```{r Superhost Status, echo=FALSE, message=FALSE, warning=FALSE}
# Calculate percentages and relabel values
superhost_data <- BCN_Accomm %>%
  count(host_is_superhost) %>%
  mutate(
    percentage = n / sum(n) * 100,  # Calculate percentages
    host_is_superhost = recode(host_is_superhost, "f" = "False", "t" = "True")  # Relabel
  )

# Create the pie chart with percentages
pc_sh_status <- ggplot(superhost_data, aes(x = "", y = n, fill = host_is_superhost)) +
  geom_col() +
  coord_polar(theta = "y") +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), position = position_stack(vjust = 0.5)) +  # Add percentages
  labs(
    title = "Proportion of Superhost Status",
    fill = "Superhost Status\n(False = Not a Superhost, True = Superhost)"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center and bold title
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9)
  )

print(pc_sh_status)
```

Almost 19% of the hosts offering an Airbnb in Barcelona are not categorized as Superhosts. This means tourists can find accommodations in the city where hosts go above and beyond to provide excellent hospitality. This insight could be a key factor in explaining the higher price values observed in certain neighborhoods.

### 3.5 Plots for String Variables

This section presents a variety of plots for the categorical variables, including Property Type, Room Type, Top Neighbourhoods, and Amenities.

```{r Top 10 property types, echo=FALSE, message=FALSE, warning=FALSE}
# Filter for the top 10 property types and calculate percentages
top_property_types <- BCN_Accomm %>%
  count(property_type, sort = TRUE) %>%
  slice_max(n, n = 10) %>%  # Keep the top 10 most frequent property types
  mutate(percentage = n / sum(n) * 100)  # Calculate percentages

# Create the bar plot with percentages and labels
top_property <- ggplot(top_property_types, aes(x = reorder(property_type, percentage), y = percentage, fill = property_type)) +
  geom_col() +
  geom_text(aes(label = paste0(round(percentage, 1))), hjust = -0.2, size = 4) +  # Add percentage labels
  coord_flip() +  # Flip coordinates for better readability
  labs(title = "Top 10 Property Types by Percentage", x = "Property Type", y = "Percentage (%)") +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"))  # Center and bold title)

print(top_property)
```

From the plot above, it can be observed that apartments dominate the Airbnb market in Barcelona, accounting for 86% of the listings.

On the other hand, the low availability of luxury or specialized accommodations, such as Boutique Hotels (0.5%), Guest Suites (0.7%), and Lofts (2.4%), suggests that these property types cater to a niche market. Travelers opting for these accommodations are likely visiting Barcelona for specific reasons, such as work or unique travel experiences.

```{r Barplots Room Type, echo=FALSE, message=FALSE, warning=FALSE}
# Reshape the dataset to long format 
BCN_Accomm_long <- BCN_Accomm %>%
  pivot_longer(cols = c(room_type), names_to = "variable", values_to = "value")

# Calculate the percentage for each category within the room_type variable
BCN_Accomm_percentage <- BCN_Accomm_long %>%
  group_by(variable, value) %>%
  summarize(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)

# Create a barplot
room_type_plot <- ggplot(BCN_Accomm_percentage, aes(x = value, y = percentage, fill = variable)) +
  geom_bar(stat = "identity") + 
  labs(title = "Percentage Barplot for Room Type", x = "Category", y = "Percentage (%)") +
  theme_minimal() + 
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"))

print(room_type_plot)
```

The majority of Room Type are split between Entire home/Apartment and Private Room.

Less than 1% of the hosts offer Shared Room, which suggests that travellers prefer more privacy during the stay.

```{r Top 10 Neighbourhoods, echo=FALSE, message=FALSE, warning=FALSE}
# Filter for the top 10 neighbourhoods and calculate percentages
top_neighbourhoods <- BCN_Accomm %>%
  count(neighbourhood, sort = TRUE) %>%
  slice_max(n, n = 10) %>%
  mutate(percentage = n / sum(n) * 100)  # Calculate percentages

# Create the plot with percentages and labels
top_neighbourhoods <- ggplot(top_neighbourhoods, aes(x = reorder(neighbourhood, percentage), y = percentage, fill = neighbourhood)) +
  geom_col() +
  geom_text(aes(label = paste0(round(percentage, 1))), hjust = -0.2, size = 4) +  # Add percentage labels
  coord_flip() +
  labs(title = "Top 10 Neighbourhoods by Percentage", x = "Neighbourhood", y = "Percentage (%)") +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"))

print(top_neighbourhoods)
```

The Eixample district of Barcelona represents the most popular neighbourhood on Airbnb, with 27% of the total listings. This is followed by Ciutat Vella, which accounts for 18.8% of the listings.

Eixample is situated in close proximity to the historic centre of the city and is more centrally located in comparison to other neighbourhoods. The area offers many attractions for tourists, including La Sagrada Familia, Casa Batlló, and Passeig de Gràcia. In addition to its excellent transport connections, Eixample is an ideal destination for visitors. 

On the other hand, Ciutat Vella is the oldest part of Barcelona and serves as the heart of the city, known for its historical charm and vibrant cultural scene. 

Given this, the Tourism Company in Zürich could recommend that its clients focus on these neighbourhoods to attract more customers and enhance their travel experience.

### Worldcloud for Amaneties

```{r Wordcloud for amanities, echo=FALSE, message=FALSE, warning=FALSE}
# Combine all amenities into a single text string and clean it
amenities_text <- BCN_Accomm$amenities %>%
  paste(collapse = " ") %>%                # Combine all rows into one string
  gsub("\\[|\\]|'", "", .)                 # Remove brackets and quotes from the field

# Split the text into words and calculate word frequencies
word_freq <- table(unlist(strsplit(amenities_text, ", ")))

# Create the word cloud
wordcloud(words = names(word_freq), 
          freq = as.numeric(word_freq), 
          min.freq = 10,                   # Minimum frequency for words to appear
          scale = c(3, 0.5),               # Word size scale
          random.order = FALSE,            # Words ordered by frequency
          colors = brewer.pal(8, "Dark2"))
```

The Wordcloud above, provides the most common amenities offered by the different hosts. 

The most prominent amenities are: Kitchen, Wifi, Heating, Washer and Hair dryer. his can be taken to indicate that tourists may consider a place to be comfortable for their stay if it meets these basic requirements.

### 3.5 Summary Statistics (FB)


## 4 Visualization Insights
This section was designed to allow the employees of the Tourism Company and other Users to interact with the data on neighborhoods, prices, and reviews.

### 4.1 Airbnb locations by neighbourhood with Interactive panel 

The purpose of the following interactive plot is to allow users to select a neighborhood of interest and visualize, on a map, the different accommodations available along with their price per night when one of the circles is clicked.

```{r  Airbnb locations, echo = FALSE}
# Sample Shiny app for leaflet map with neighborhood filter
ui <- fluidPage(
  titlePanel("Airbnb Prices by Neighbourhood"),
  sidebarLayout(
    sidebarPanel(
      # Drop down to select neighborhood
      selectInput("neighbourhood", "Select Neighbourhood:", choices = sort(unique(BCN_Accomm$neighbourhood)))
    ),
    mainPanel(
      leafletOutput("map") # main content area where the map will be displayed
    )
  )
)

server <- function(input, output, session) {
  # Dropdown to select neighbourhood, sorted alphabetically
  filtered_data <- reactive({
    BCN_Accomm[BCN_Accomm$neighbourhood == input$neighbourhood, ]
  })

  # Render leaflet map
  output$map <- renderLeaflet({
    leaflet(filtered_data()) %>%
      addTiles() %>%
      setView(lng = 2.154007, lat = 41.390205, zoom = 12) %>% #Location of Barcelona
      addCircleMarkers(
        lng = ~longitude,
        lat = ~latitude,
        color = "blue",
        popup = ~paste("<b>Price:</b> €", price, "<br>",
          "<b>Type:</b>", room_type, "<br>",
          "<b>Neighbourhood:</b>", neighbourhood)
      )
  })
}

# Run the Shiny app
shinyApp(ui, server)
```

### 4.2 Heatmap of prices
In the heatmap below, users can observe the zones with higher accommodation prices (red/orange areas).

In contrast, the zones colored in green or blue represent lower-priced neighborhoods.

According to the heatmap, the Tourism Company can recommend the red zones to tourists looking for more centralized accommodations, regardless of price. On the other hand, tourists who want to save money can be advised to choose accommodations in the green or blue areas, which are typically farther from the city center.

```{r Heatmap of prices, echo = FALSE}
# Mean price per neighbourhood 
neighborhood_means <- BCN_Accomm %>%
    group_by(neighbourhood) %>%
    summarize(mean_price = mean(price, na.rm = TRUE),
              latitude = mean(latitude, na.rm = TRUE),
              longitude = mean(longitude, na.rm = TRUE))
# Create Map

leaflet(data = BCN_Accomm) %>%
    addProviderTiles("CartoDB.Positron") %>%  
    addHeatmap(
        lng = ~longitude,
        lat = ~latitude,
        intensity = ~price,
        blur = 25,       
        max = 0.03,          
        radius = 15    
    ) %>%
    addMarkers(
        data = neighborhood_means,
        ~longitude, ~latitude,
        popup = ~paste(
            "<strong>Neighborhood:</strong>", neighbourhood,
            "<br><strong>Mean Price (€):</strong>", round(mean_price, 2)
        )
    ) %>%
    addLegend(
        "bottomright",
        pal = colorNumeric("viridis", BCN_Accomm$price),
        values = BCN_Accomm$price,
        title = "Price (€)",
        opacity = 0.7
    )

```

## 4.3 Review Score Rating vs. Price by Room Type

```{r Review Score Rating vs. Price by Room Type, echo = FALSE, warning=FALSE}
#display.brewer.all() #Visualize color palette
ggplot(BCN_Accomm, aes(x = review_scores_rating, y = price, color = room_type)) +
  geom_point(alpha = 0.6) + 
  #scale_color_brewer(palette = "Set2") +
  labs(title = "Scatter Plot of Review Score Rating vs. Price by Room Type",
       x = "Review Score Rating",
       y = "Price",
       color = "Room Type") + 
  theme_minimal()

```

From the plot above, the following insights can be derived:
- The majority of listings are concentrated at the lower price range (below 250 Euros), irrespective of room type.
- Accommodations with high review scores (exceeding 90 points) are distributed across all price categories, indicating that well-reviewed Airbnbs are not restricted to a particular room type or price range.

# 5 Machine Learning Models

In this chapter, different machine learning models will be explored to predict Airbnb prices and the occupancy rate over the next 30 days.

The formula to calculate the Occupancy rate in 30 days is:

**Occupancy Rate**:
$$

\text{Occupancy Rate} = \left(1 - \frac{\text{Availability 30 Days}}{\text{Total Days = 30}}\right) \times 100

$$
According to the formula above, a new columns with the Occupancy rate is calculated and the head data of the new variable Occupancy_rate_30 is:

```{r New column for Occupancy rate, echo = FALSE}
# Create a new column for occupancy rate
BCN_Accomm$occupancy_rate_30 <- (1 - BCN_Accomm$availability_30 / 30) * 100

# Preview the new column
head(BCN_Accomm$occupancy_rate_30)

```

With this new predictor, the Occupancy rate in the next 30 days is going to be predicted.

As mentioned in the previous chapters, the categorical variables are converted into factors to proceed with the modeling phase.

```{r Covert categorical variables into factors}
# Remove rows with the unwanted neighborhoods
BCN_Accomm <- BCN_Accomm[!(BCN_Accomm$neighbourhood %in% c("La Vall d'Hebron", "Torre Baró")), ]

# converting categorical variables into factors
BCN_Accomm$neighbourhood <- as.factor(BCN_Accomm$neighbourhood)
BCN_Accomm$property_type <- as.factor(BCN_Accomm$property_type)
BCN_Accomm$room_type <- as.factor(BCN_Accomm$room_type)
BCN_Accomm$zipcode <- as.factor(BCN_Accomm$zipcode)
BCN_Accomm$availability_30 <- as.factor(BCN_Accomm$availability_30)

# Convert variables that represent counts or continuous numbers into numeric
# If these were read as characters or factors, ensure they're numeric:
if (is.factor(BCN_Accomm$accommodates)) {
  BCN_Accomm$accommodates <- as.numeric(as.character(BCN_Accomm$accommodates))
}
if (is.factor(BCN_Accomm$bathrooms)) {
  BCN_Accomm$bathrooms <- as.numeric(as.character(BCN_Accomm$bathrooms))
}
if (!is.numeric(BCN_Accomm$bedrooms)) {
  BCN_Accomm$bedrooms <- as.numeric(BCN_Accomm$bedrooms)
}
if (!is.numeric(BCN_Accomm$beds)) {
  BCN_Accomm$beds <- as.numeric(BCN_Accomm$beds)
}
if (!is.numeric(BCN_Accomm$latitude)) {
  BCN_Accomm$latitude <- as.numeric(BCN_Accomm$latitude)
}
if (!is.numeric(BCN_Accomm$longitude)) {
  BCN_Accomm$longitude <- as.numeric(BCN_Accomm$longitude)
}
if (!is.numeric(BCN_Accomm$review_scores_rating)) {
  BCN_Accomm$review_scores_rating <- as.numeric(BCN_Accomm$review_scores_rating)
}
if (!is.numeric(BCN_Accomm$minimum_nights)) {
  BCN_Accomm$minimum_nights <- as.numeric(BCN_Accomm$minimum_nights)
}

# Ensure zipcodes are cleaned or set unknowns
BCN_Accomm$zipcode <- ifelse(grepl("^[0-9]{4}$", BCN_Accomm$zipcode), 
                             BCN_Accomm$zipcode, 
                             "unknown")
BCN_Accomm$zipcode <- as.factor(BCN_Accomm$zipcode)
```

## Train and Test data

```{r zipcode_cleaning, include = FALSE}
# Replace invalid zipcodes with "unknown"
BCN_Accomm$zipcode <- ifelse(
  grepl("^[0-9]{4}$", BCN_Accomm$zipcode),   # Check if zipcode is exactly 4 digits
  BCN_Accomm$zipcode,                        # Keep valid zipcodes
  "unknown")                                # Replace invalid zipcodes with "unknown"
```

Before analysing the different models, we need to divide the data into a training set and test set.
The first set will be used to find the relationship between dependent and independent variable, while the second set will be used to analyse the performance of the models. 
We decide to use 60% of the data set as a training set, and the rest as a test set.

```{r Train and Test split}
set.seed(1000)
# Define the number of groups and the amount of sample for each
group <- sample(2, nrow(BCN_Accomm),
                replace = TRUE,
                prob = c(0.4, 0.4))

# training data set with around 60% of the samples
train <- BCN_Accomm[group==1,]

# test data set with around 40% of the samples
test <- BCN_Accomm[group==2,]
test <- na.omit(test)

```

```{r}
# For all factor variables used in the model, ensure that the test factors have the same levels as train
test$property_type <- factor(test$property_type, levels = levels(train$property_type))
test$room_type <- factor(test$room_type, levels = levels(train$room_type))
test$neighbourhood <- factor(test$neighbourhood, levels = levels(train$neighbourhood))

```


```{r}
# Ensure no NAs or infinite values in important numeric variables
numeric_vars <- c("bathrooms", "bedrooms", "accommodates", "beds", 
                  "latitude", "longitude", "review_scores_rating", "minimum_nights")
```


Next, based on the Correlation Matrix, showed in chapter 3.4, the variables used to address the first reasearch question about price, are:

- **`bedrroms`**
- **`bathrooms`**
- **`accomodates`**
- **`beds`**
- **`latitude and longitude`**
- **`review_score_rating`**
- **`minimum_nights`**
- **`property_type`**
- **`room_type`**

The variables used for the Occupancy rate in one month are:

- **`latitude`** and **`longitude`** (location)
- **`bathrooms`**
- **`bedrooms`**
- **`accommodates`**
- **`beds`**
- **`price`**
- **`minimum_nights`**
- **`availability_30`**
- **`availability_60`**
- **`availability_90`**
- **`availability_365`**
- **`review_scores_rating`**
- **`property_type`**
- **`room_type`**

`

## 5.1 Linear Model
It is used to analyse  .... and answer the project question x
- Accurancy
- Precision
- Recall
- RMSE (Root Mean Squared Error)
- MAE (Mean Absolute Error)
- R Squared

## 5.2 Generalised Linear Model with family set to Poisson
It is used to analyse  .... and answer the project question x
- Accurancy
- Precision
- Recall
- RMSE (Root Mean Squared Error)
- MAE (Mean Absolute Error)
- R Squared

## 5.3 Generalised Linear Model with family set to Binomial or Multinomial data

1. What are the key factors influencing accommodation prices in Barcelona?
2. Can we predict occupancy rates based on location, amenities, or other factors?

## 5.4 Generalised Additive Model

In this chapter, Generalized Additive Models (GAMs) will be applied with the Price variable as the response, to analyze its interactions with the predictor variables.

The first goal is to identify key factors influencing prices in Barcelona, addressing Research Question 1 (What are the key factors influencing accommodation prices in Barcelona?)

First, we aim to determine whether a nonlinear relationship exists between the independent variables and price. To explore this, the variable Review Score Rating will be plotted against Price to visualize whether the relationship is linear or not.

```{r Price Vs Number of Review Score rating, echo=FALSE}
# Bedrooms vs Price
ggplot(BCN_Accomm, aes(x = review_scores_rating, y = price)) +
  geom_point(color = "blue") +
  geom_smooth(method = "loess", color = "red") + # Loess: on-parametric method for fitting a curve to the data.
  labs(title = "Price vs Review Score Ratings", x = "Review Score", y = "Price")+
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"))
```

From the plot above and Chapter 4.3 of this report, we observe that many points are concentrated on the right side, where higher review scores are paired with lower prices. This suggests a lack of a strong relationship between Review Score Ratings and Price.

Given that at least one variable does not exhibit a linear relationship, we will proceed with applying a Generalized Additive Model (GAM) to better capture potential nonlinear interactions.

### 5.4.1 Gam Model Training for Price Prediction

The formula for the Gam Model is:

$$
\text{Price} = \beta_0 + f_1(\text{bathrooms}) + f_2(\text{bedrooms}) + f_3(\text{accommodates}) + f_4(\text{beds}) + f_5(\text{latitude}) + f_6(\text{longitude}) + f_7(\text{review\_scores\_rating}) + f_8(\text{minimum\_nights}) + \beta_1(\text{room\_type}) + \beta_2(\text{neighbourhood}) + \epsilon
$$
```{r Fit Gam Model, echo = FALSE}
# Gam Model
gam_price <- gam(price ~ 
                   s(bathrooms) + s(bedrooms) + s(accommodates) + s(beds) +
                   s(latitude) + s(longitude) +
                   s(review_scores_rating) + s(minimum_nights) +
                   room_type + neighbourhood,
                 data = train, method = "REML")

# Summary of the occupancy model
summary(gam_price)
```

### 5.4.2 Gam Model Prediction of pricing evaluation

```{r Gam Prediction, echo = FALSE}
# Make sure test has no problematic values before predicting
test$predicted_price <- predict(gam_price, newdata = test)

# Calculate R-squared on the test set
r_squared <- 1 - sum((test$price - test$predicted_price)^2) / sum((test$price - mean(test$price))^2)
cat("R-squared on Test Set: ", r_squared, "\n")

# Plot observed vs predicted with points in blue
ggplot(test, aes(x = price, y = predicted_price)) +
  geom_point(alpha = 0.5, color = "blue") +  # Set points color to blue
  geom_abline(slope = 1, intercept = 0, color = "red") +
  labs(title = "Observed vs Predicted Prices (Test Set)",
       x = "Observed Price", y = "Predicted Price") +
  theme_minimal()

```

### 5.4.3 Gam Model Evaluate Predictive Performance

```{r Gam Evaluation Predictive performance, echo = FALSE}
# Calculate errors
mae <- mean(abs(test$price - test$predicted_price))
rmse <- sqrt(mean((test$price - test$predicted_price)^2))
r_squared <- 1 - sum((test$price - test$predicted_price)^2) / sum((test$price - mean(test$price))^2)

cat("MAE: ", mae, "\n")
cat("RMSE: ", rmse, "\n")
cat("R-squared: ", r_squared, "\n")

```

### 5.4.4 Gam Model Training for Occupancy Prediction

```{r}
# Fit the GAM model
gam_occupancy_30 <- gam(occupancy_rate_30 ~ 
                          s(latitude) + s(longitude) + 
                          s(bathrooms) + s(bedrooms) + s(accommodates) + s(beds) +
                          s(price) + s(minimum_nights) + 
                          s(review_scores_rating) + (neighbourhood),
                        data = train, method = "REML")

# Summary of the GAM model
summary(gam_occupancy_30)
```


### 5.4.5 Gam Model Prediction of occupancy Rate

```{r Gam Occupancy Prediction, echo = FALSE}
# Make predictions on the test set using gam_occupancy_30
test$predicted_occupancy_30 <- predict(gam_occupancy_30, newdata = test)

# Calculate R-squared on the test set
r_squared_occupancy <- 1 - sum((test$occupancy_rate_30 - test$predicted_occupancy_30)^2) / 
                          sum((test$occupancy_rate_30 - mean(test$occupancy_rate_30))^2)
cat("R-squared on Test Set (Occupancy 30): ", r_squared_occupancy, "\n")

# Plot observed vs predicted occupancy with blue points
ggplot(test, aes(x = occupancy_rate_30, y = predicted_occupancy_30)) +
  geom_point(alpha = 0.5, color = "blue") +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  labs(title = "Observed vs Predicted Occupancy (Test Set)",
       x = "Observed Occupancy (30 days)", y = "Predicted Occupancy (30 days)") +
  theme_minimal()
```

## 5.5 Neural Network
It is used to analyse  .... and answer the project question x
- Accurancy
- Precision
- Recall
- RMSE (Root Mean Squared Error)
- MAE (Mean Absolute Error)
- R Squared

## 5.6 Support Vector Machine
It is used to analyse  .... and answer the project question x
- Accurancy
- Precision
- Recall
- RMSE (Root Mean Squared Error)
- MAE (Mean Absolute Error)
- R Squared

## 5.7 Models comparison and evaluation (after models completed)
- Accurancy
- Precision
- Recall
- RMSE (Root Mean Squared Error)
- MAE (Mean Absolute Error)
- R Squared

# 6. Use of Generative AI (notes from everyone to collect and formulate)
– how you used generative AI in redacting the group work (code-related questions,
generate text, explain concepts…)
– what was easy/hard/impossible to do with generative AI
– what you had to pay attention to/be critical about when using the results obtained
through the use of generative AI

# 7. Conclusions (together at the end)
- Summary of key insights
- Predictive Model Performance (can we answer our research questions?)
- Implications
- Limitations
- Future work 

# 8. Appendix (CR)
Table with the description of every variable and the type

# 9. References 
- website
- literature


