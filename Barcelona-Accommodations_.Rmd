---
title: "Machine Learning Methods: Analysing Barcelona Accommodations"
author: "Martina Diaz, Fatima Barcina, Catalina Roth"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true          # Enables the table of contents
    toc_depth: 3       # Control the depth of headers to include in the TOC
    toc_float: true    # Makes the TOC float on the page
  pdf_document:
    toc: true          # Enables the table of contents for PDF output
    toc_depth: 2       # Controls the depth of headers to include in the TOC
  word_document:
    toc: true          # Enables the table of contents for Word output
    toc_depth: 2       # Controls the depth of headers to include in the TOC
editor_options: 
  chunk_output_type: html
always_allow_html: true
runtime: shiny
---

```{r download packages, include = FALSE}
options(repos = c(CRAN = "https://cran.rstudio.com/"))
#file.edit("~/.Rprofile")
```

```{r setup!, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#options(repos = c(CRAN = "https://cran.rstudio.com/"))
```

```{r pressure., echo=FALSE, warning=FALSE, out.width='60%', fig.align='center', fig.cap="Barcelona's Digital Landscape: a data-driven exploration of urban dynamics around Sagrada Familia. AI-generated by our team."}
knitr::include_graphics("Barcelona Picture.png")
```

```{r Packages, include=FALSE}
install.packages(c("dplyr", "ggplot2", "tidyr", "RColorBrewer", "leaflet", "shiny", "leaflet.extras", "corrplot", "treemap", "wordcloud", "mgcv", "gratia"))
```

```{r libraries, include=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(RColorBrewer)
library(leaflet)
library(shiny)
library(leaflet.extras)
library(RColorBrewer)
library(mice)
library(corrplot)
library(knitr)
library(treemap)
library(wordcloud)
library(mgcv) # GAM
library(gratia)
```

# 1. Introduction

## 1.1 Presentation of the case

A tourism company based in Zürich, Switzerland, has observed a significant increase in travel demand to Barcelona in recent years. Indeed, Barcelona ranks as the third most in-demand city for Airbnb rentals in Europe, behind Paris and London.

Consequently, the company’s manager has requested a Machine Learning study and analysis of Airbnb accommodations in the city. The goal is to understand price behavior and identify the factors influencing accommodation costs and occupancy, enabling the company to provide optimal responses to clients' inquiries.

To achieve this goal, the team has decided to analyse and address three question to provide comprehensive insights for the manager.

1. **What are the key factors influencing accommodation prices in Barcelona?**
2. **Can we predict occupancy rates based on location, amenities, or other factors?**
3. **How accurately can machine learning predict Airbnb prices in Barcelona? Which models perform best for this dataset?**

## 1.2 Motivations
Barcelona is one of the most visited cities in Europe, and the rise of Airbnb and other short-term rental platforms has led to a notable increase in tourism. However, this growth also presents challenges for accommodation businesses and the local housing market. A study conducted by the Social Science Research Network (<span style="color:blue">SSRN, link: https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3428237</span>) revealed that rental costs in neighborhoods with high Airbnb activity increased by 7% between 2009 and 2016. This is primarily due to the fact that property owners, motivated by the demand from tourists seeking short-term rentals, frequently opt to lease their properties at higher rates during the short term rather than committing to long-term leases.

For these reasons, it is crucial for tourism companies to understand this dynamic market to remain competitive and provide tailored services to their clients.

The Zürich-based tourism company needs reliable data on Airbnb prices and occupancy rates to make data-driven recommendations and stay ahead of competitors.

## 1.3 Disclaimer
This analysis is for educational purposes only. The findings are based on public data and are not professional advice. The results should not be used for business or policy decisions.

## 1.4 Dataset selected

To conduct the study, the team has decided to analyse a dataset of Barcelona Airbnbs available on the Kaggle website (<span style="color:blue">link: https://www.kaggle.com/datasets/fermatsavant/airbnb-dataset-of-barcelona-city</span>)

The dataset consists of 19.833 observations across 25 variables, including geographical zones, amenities, prices, and accommodations.


```{r dataset download, include=FALSE}
# import the dataset
BCN_Accomm_full <- read.csv("Cleaned_airbnb_barcelona.csv")
```

Below, we can see the structure of the dataset, and the names and data types for each column.

```{r Structure dataset, echo = FALSE}
# Structure
glimpse(BCN_Accomm_full)
```

### Numerical values:
- **`X`**: numerical index for rows
- **`id`**: unique identifier for listings
- **`host_id`**: unique identifier for hosts
- **`host_listings_count`**: number of listings by the host
- **`latitude`**: geographic latitude of the listing
- **`longitude`**: geographic longitude of the listing
- **`accommodates`**: number of guests the listing can accommodate
- **`bathrooms`**: number of bathrooms in the listing
- **`bedrooms`**: number of bedrooms in the listing
- **`beds`**: number of beds in the listing
- **`minimum_nights`**: minimum number of nights required for booking
- **`availability_30`**: number of available nights in the next 30 days
- **`availability_60`**: number of available nights in the next 60 days
- **`availability_90`**: number of available nights in the next 90 days
- **`availability_365`**: number of available nights in the next 365 days
- **`number_of_reviews_ltm`**: number of reviews in the last 12 months
- **`review_scores_rating`**: average review rating score

### Binary variables:
- **`host_is_superhost`**: indicates if the host is a superhost (`"t"` or `"f"`)
- **`has_availability`**: indicates if the listing is available for booking (`"t"` or `"f"`)

### String values:
- **`neighbourhood`**: name of the neighbourhood where the listing is located
- **`zipcode`**: postal code of the listing
- **`property_type`**: type of property (e.g., "Apartment")
- **`room_type`**: type of room (e.g., "Entire home/apt")
- **`amenities`**: list of amenities provided in the listing
- **`price`**: price of the listing as a string (e.g., "$130.00")


As can be appreciated, the variable 'price' has a 'Character' data type. Therefore, in the chapter 3, this field will be transformed into an integer variable to enable the necessary calculations.

(Do we want to indicate binary and binomial/multinomial data?)

## 1.5 Sub-sampling

In order to streamline the calculations and analysis, a sub-dataset will be created in the following steps, considering 10.000 observations selected randomly. Additionally, a seed is created to ensure the same observations are maintained throughout the analysis

```{r sub-set, echo=FALSE}
set.seed(100)
BCN_Accomm_sub <- sample_n(BCN_Accomm_full, 10000) 
glimpse(BCN_Accomm_sub)
```

# 2. Methodology

To address the research question, the study will be divided into three parts. First, an Exploratory Data Analysis (EDA) will be conducted to gain a deeper understanding of the data. Second, Machine Learning models will be implemented, and their performance will be evaluated to identify the best-performing model. Finally, the selected model will be used to provide the most accurate answer to the research question posed by the team.

The different models to be developed are: 

1. Linear Model (FB)
2. Generalised Linear Model with family set to Poisson for binary data (FB)
3. Generalised Linear Model with family set to Binomial for binomial and multinomial data (MD)
4. Generalised Additive Model for (CR)
5. Neural Network for (CR)
6. Support Vector Machine for (MD)

# 3 Exploratory Data Analysis

## 3.1 Converting Price variable to numeric

```{r Convert price to numeric}
BCN_Accomm_sub$price <- gsub(",", "", BCN_Accomm_sub$price) # removed ','
BCN_Accomm_sub$price <- gsub("\\$", "", BCN_Accomm_sub$price) # removed '$' sign
BCN_Accomm_sub$price <- as.numeric(BCN_Accomm_sub$price)  # converted to number format
```

## 3.1 Missing values (detect and treat) (MD) 

```{r miss-values}
print('Location of missing values')
# find location of missing values column wise
sapply(BCN_Accomm_sub, function(x) which(is.na(x)))
# count the missing values column wise
sapply(BCN_Accomm_sub, function(x) sum(is.na(x)))
```

```{r patt-miss-values}
md.pattern(BCN_Accomm_sub, rotate.names = TRUE)
```

```{r tab-miss-values, echo = FALSE}
# Total observations
total_rows <- nrow(BCN_Accomm_sub) 

# Calculate missing values (count and percentage)
missing_values <- data.frame(
  #Variable = names(BCN_Accomm_full),
  Missing_Count = colSums(is.na(BCN_Accomm_sub)),
  Missing_Percent = paste0(round((colSums(is.na(BCN_Accomm_sub)) / total_rows) * 100, 2), "%"))

# Order DataFrame table in descending order
missing_values <- missing_values[order(-missing_values$Missing_Count), ]

# Display the table
knitr::kable(missing_values, 
             caption = "Missing Values by Variable",
             align = "c")
```

**How to manage the missing values for each field.**
host_listings_count : since is not possible to make any calculation on the number of listing of the host, we exclude the 22 rows that lack of it.
bathrooms : the number of bathrooms is missing in 6 rows. 
beds : the number of beds is not specified for 18 assets. 
bedrooms : 2 rows contains missing value and can be deleted.
review_scores_rating : the review score rating is missing in 2415 rows of 10000. It's a quite relevant percentage, around the 24% of the data we selected. In this case we decide to impute the missing values replacing it with the value 0.

```{r imputation_review_score_rating}
# Create a new data frame with the imputed review_scores_rating column
imp_BCN_Accomm_sub <- BCN_Accomm_sub %>%
  mutate(review_scores_rating = if_else(is.na(review_scores_rating), 0, review_scores_rating))

md.pattern(imp_BCN_Accomm_sub, rotate.names = TRUE)
```

Eventually, the other fields that present missing values do not allow to replace the empty data with estimates (average, mean, ...) so called imputation. This fields include in total 48 assets that represent 0.48% of the total assets and allows to delete the entire rows without loosing too many information.

```{r removing-rows}
BCN_Accomm <- na.omit(imp_BCN_Accomm_sub) # from this point we'll use this data set
md.pattern(BCN_Accomm, rotate.names = TRUE)
```

## 3.2 Correlation matrix

```{r correlation_matrix_numeric_fields}
# include price - use CR 
# Create a correlation matrix for numeric fields
cor_BNC_Accomm <- select_if(BCN_Accomm, is.numeric) %>%
  select(-c(id, X, host_id))

# make a data frame
cor_BNC_Accomm <- data.frame(cor_BNC_Accomm)
str(cor_BNC_Accomm)

# print correlation matrix
corrplot(cor(cor_BNC_Accomm), type = "upper", order = "hclust", tl.col = "black")
```

From the correlation matrix is possible to deduct the following characteristics:
- there's almost no correlation between availability periods and number of beds, bedrooms, bathrooms. It would suggest that the availability of the house do not depend from those features, rather probably from the location and facilities.
- there is a positive correlation between number of bedrooms, beds and bathrooms.
- there is a positive correlation between the availability periods. 

## 3.3 Outliers (boxplots) (detect and treat) (CR)
Since the price variable is a key focus of our analysis, an outlier analysis of this variable has been conducted.

### 3.1 Count of outliers in Price

```{r Outliers for the variable Price, echo = FALSE}
# Calculate Q1, Q3, and IQR for the price variable
Q1 <- quantile(BCN_Accomm$price, 0.25)
Q3 <- quantile(BCN_Accomm$price, 0.75)
IQR <- Q3 - Q1

# Add a column to indicate outliers 
BCN_Accomm_sub_outlier <- BCN_Accomm %>%
  mutate(is_outlier = price < (Q1 - 1.5 * IQR) | price > (Q3 + 1.5 * IQR))

# Count the number of outliers
outliers_count <- sum(BCN_Accomm_sub_outlier$is_outlier)

# Display outliers count
outliers_count

```

Out of a total of 10,000 values, 804 (8.04%) are identified as outliers. Below, a boxplot is presented to visualize the median and the outlier observations.

```{r Boxplot Price, echo= FALSE}
# Boxplot for price variable
boxplot(BCN_Accomm$price, 
        horizontal = TRUE,
        axes = FALSE, 
        staplewex = 1, 
        ylim = c(2, 500),
        main = "Boxplot of Price/Night Variable (€)")  

# X Axis
axis(1, las = 1)

# Add text labels values (Q1, Q3, IQR)
stats <- boxplot.stats(BCN_Accomm$price)$stats
text(x = stats, y = 1.25, labels = stats, pos = 3, cex = 0.9) 
```

From the boxplot above, it can be concluded that the median price is approximately 65€ per night, with 50% of the observations concentrated between 40€ (25th percentile) and 112€ (75th percentile), representing the interquartile range (IQR).

Additionally, the presence of numerous outliers extending to the right indicates a right-skewed distribution, meaning higher prices are influencing the dataset.

The significant number of observations with higher prices could suggest the presence of many luxury properties. Therefore, further analysis is required to identify the factors influencing these price variations.

### Detecting Top 20 Price Outliers

```{r Filter outliers, echo = FALSE}
# Filter rows Outliers
outlier_extremes <- BCN_Accomm_sub_outlier%>%
  filter(is_outlier == TRUE) %>%
  select(neighbourhood, property_type, bedrooms, price) %>%
  arrange(desc(price), neighbourhood, property_type) %>%
  slice_head(n = 20)  # Select top 20 Outliers for price

# Display Prices outliers
knitr::kable(outlier_extremes, 
             caption = "Table 2: Top 20 and Outliers for Price Variable with Neighbourhood",
             align = "c")
```


### 3.3 Histograms for Numerical Variables(CR)

```{r Histograms Numerical Variables, echo=FALSE, warning=FALSE}

# Reshape the data set to long format
BCN_Accomm_hist <- BCN_Accomm %>%
  pivot_longer(cols = c(price,
                        accommodates,
                        bathrooms,
                        bedrooms,
                        beds,
                        minimum_nights,
                        number_of_reviews_ltm,
                        review_scores_rating
),  
               names_to = "variable", values_to = "value")

# Create histograms with facet_wrap
hist_num <- ggplot(BCN_Accomm_hist, aes(x = value)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black") +  
  labs(title = "Histograms for Numerical Variables", x = "Value", y = "Frequency") +
  facet_wrap(~variable, scales = "free") +  # each plot with their own y axes
  theme_minimal()

print(hist_num)
```

From the histograms above, several variables exhibit right-skewed distributions, including price, minimum_nights, and number_of_reviews_ltm.

On the other hand, the data suggests that in Barcelona, Airbnb listings are primarily designed for small groups of people seeking short-term stays. Additionally, these accommodations tend to receive high review scores, indicating good guest satisfaction with the different properties.

### 3.4 Pie Charts for Binary Variable "Host_is_superhost"

```{r Superhost Status, echo=FALSE, message=FALSE, warning=FALSE}
# Calculate percentages and relabel values
superhost_data <- BCN_Accomm %>%
  count(host_is_superhost) %>%
  mutate(
    percentage = n / sum(n) * 100,  # Calculate percentages
    host_is_superhost = recode(host_is_superhost, "f" = "False", "t" = "True")  # Relabel
  )

# Create the pie chart with percentages
pc_sh_status <- ggplot(superhost_data, aes(x = "", y = n, fill = host_is_superhost)) +
  geom_col() +
  coord_polar(theta = "y") +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), position = position_stack(vjust = 0.5)) +  # Add percentages
  labs(
    title = "Proportion of Superhost Status",
    fill = "Superhost Status\n(False = Not a Superhost, True = Superhost)"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center and bold title
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9)
  )

print(pc_sh_status)
```

Almost 19% of the hosts offering an Airbnb in Barcelona are not categorized as Superhosts. This means tourists can find accommodations in the city where hosts go above and beyond to provide excellent hospitality. This insight could be a key factor in explaining the higher price values observed in certain neighborhoods.

### 3.5 Plots for String Variables

This section presents a variety of plots for the categorical variables, including Property Type, Room Type, Top Neighbourhoods, and Amenities.

```{r Top 10 property types, echo=FALSE, message=FALSE, warning=FALSE}
# Filter for the top 10 property types and calculate percentages
top_property_types <- BCN_Accomm %>%
  count(property_type, sort = TRUE) %>%
  slice_max(n, n = 10) %>%  # Keep the top 10 most frequent property types
  mutate(percentage = n / sum(n) * 100)  # Calculate percentages

# Create the bar plot with percentages and labels
top_property <- ggplot(top_property_types, aes(x = reorder(property_type, percentage), y = percentage, fill = property_type)) +
  geom_col() +
  geom_text(aes(label = paste0(round(percentage, 1))), hjust = -0.2, size = 4) +  # Add percentage labels
  coord_flip() +  # Flip coordinates for better readability
  labs(title = "Top 10 Property Types by Percentage", x = "Property Type", y = "Percentage (%)") +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"))  # Center and bold title)

print(top_property)
```

From the plot above, it can be observed that apartments dominate the Airbnb market in Barcelona, accounting for 86% of the listings.

On the other hand, the low availability of luxury or specialized accommodations, such as Boutique Hotels (0.5%), Guest Suites (0.7%), and Lofts (2.4%), suggests that these property types cater to a niche market. Travelers opting for these accommodations are likely visiting Barcelona for specific reasons, such as work or unique travel experiences.

```{r Barplots Room Type, echo=FALSE, message=FALSE, warning=FALSE}
# Reshape the dataset to long format 
BCN_Accomm_long <- BCN_Accomm %>%
  pivot_longer(cols = c(room_type), names_to = "variable", values_to = "value")

# Calculate the percentage for each category within the room_type variable
BCN_Accomm_percentage <- BCN_Accomm_long %>%
  group_by(variable, value) %>%
  summarize(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)

# Create a barplot
room_type_plot <- ggplot(BCN_Accomm_percentage, aes(x = value, y = percentage, fill = variable)) +
  geom_bar(stat = "identity") + 
  labs(title = "Percentage Barplot for Room Type", x = "Category", y = "Percentage (%)") +
  theme_minimal() + 
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"))

print(room_type_plot)
```

The majority of Room Type are split between Entire home/Apartment and Private Room.

Less than 1% of the hosts offer Shared Room, which suggests that travellers prefer more privacy during the stay.

```{r Top 10 Neighbourhoods, echo=FALSE, message=FALSE, warning=FALSE}
# Filter for the top 10 neighbourhoods and calculate percentages
top_neighbourhoods <- BCN_Accomm %>%
  count(neighbourhood, sort = TRUE) %>%
  slice_max(n, n = 10) %>%
  mutate(percentage = n / sum(n) * 100)  # Calculate percentages

# Create the plot with percentages and labels
top_neighbourhoods <- ggplot(top_neighbourhoods, aes(x = reorder(neighbourhood, percentage), y = percentage, fill = neighbourhood)) +
  geom_col() +
  geom_text(aes(label = paste0(round(percentage, 1))), hjust = -0.2, size = 4) +  # Add percentage labels
  coord_flip() +
  labs(title = "Top 10 Neighbourhoods by Percentage", x = "Neighbourhood", y = "Percentage (%)") +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"))

print(top_neighbourhoods)
```

The Eixample district of Barcelona represents the most popular neighbourhood on Airbnb, with 27% of the total listings. This is followed by Ciutat Vella, which accounts for 18.8% of the listings.

Eixample is situated in close proximity to the historic centre of the city and is more centrally located in comparison to other neighbourhoods. The area offers many attractions for tourists, including La Sagrada Familia, Casa Batlló, and Passeig de Gràcia. In addition to its excellent transport connections, Eixample is an ideal destination for visitors. 

On the other hand, Ciutat Vella is the oldest part of Barcelona and serves as the heart of the city, known for its historical charm and vibrant cultural scene. 

Given this, the Tourism Company in Zürich could recommend that its clients focus on these neighbourhoods to attract more customers and enhance their travel experience.

### Worldcloud for Amaneties

```{r Wordcloud for amanities, echo=FALSE, message=FALSE, warning=FALSE}
# Combine all amenities into a single text string and clean it
amenities_text <- BCN_Accomm$amenities %>%
  paste(collapse = " ") %>%                # Combine all rows into one string
  gsub("\\[|\\]|'", "", .)                 # Remove brackets and quotes from the field

# Split the text into words and calculate word frequencies
word_freq <- table(unlist(strsplit(amenities_text, ", ")))

# Create the word cloud
wordcloud(words = names(word_freq), 
          freq = as.numeric(word_freq), 
          min.freq = 10,                   # Minimum frequency for words to appear
          scale = c(3, 0.5),               # Word size scale
          random.order = FALSE,            # Words ordered by frequency
          colors = brewer.pal(8, "Dark2"))

```

The Wordcloud above, provides the most common amenities offered by the different hosts. 

The most prominent amenities are: Kitchen, Wifi, Heating, Washer and Hair dryer. his can be taken to indicate that tourists may consider a place to be comfortable for their stay if it meets these basic requirements.

### 3.5 Summary Statistics (FB)


## 4 Visualization Insights
This section was designed to allow the employees of the Tourism Company and other Users to interact with the data on neighborhoods, prices, and reviews.

### 4.1 Airbnb locations by neighbourhood with Interactive panel 

The purpose of the following interactive plot is to allow users to select a neighborhood of interest and visualize, on a map, the different accommodations available along with their price per night when one of the circles is clicked.

```{r  Airbnb locations, echo = FALSE}
# Sample Shiny app for leaflet map with neighbourhood filter
ui <- fluidPage(
  titlePanel("Airbnb Prices by Neighbourhood"),
  sidebarLayout(
    sidebarPanel(
      # Dropdown to select neighbourhood
      selectInput("neighbourhood", "Select Neighbourhood:", choices = sort(unique(BCN_Accomm$neighbourhood)))
    ),
    mainPanel(
      leafletOutput("map") # main content area where the map will be displayed
    )
  )
)

server <- function(input, output, session) {
  # Dropdown to select neighbourhood, sorted alphabetically
  filtered_data <- reactive({
    BCN_Accomm[BCN_Accomm$neighbourhood == input$neighbourhood, ]
  })

  # Render leaflet map
  output$map <- renderLeaflet({
    leaflet(filtered_data()) %>%
      addTiles() %>%
      setView(lng = 2.154007, lat = 41.390205, zoom = 12) %>% #Location of Barcelona
      addCircleMarkers(
        lng = ~longitude,
        lat = ~latitude,
        color = "blue",
        popup = ~paste("Price: €", price)
      )
  })
}

# Run the Shiny app
shinyApp(ui, server)
```

### 4.2 Heatmap of prices
In the heatmap below, users can observe the zones with higher accommodation prices (red/orange areas).

In contrast, the zones colored in green or blue represent lower-priced neighborhoods.

According to the heatmap, the Tourism Company can recommend the red zones to tourists looking for more centralized accommodations, regardless of price. On the other hand, tourists who want to save money can be advised to choose accommodations in the green or blue areas, which are typically farther from the city center.

```{r Heatmap of prices, echo = FALSE}
# Mean price per neighbourhood 
neighborhood_means <- BCN_Accomm %>%
    group_by(neighbourhood) %>%
    summarize(mean_price = mean(price, na.rm = TRUE),
              latitude = mean(latitude, na.rm = TRUE),
              longitude = mean(longitude, na.rm = TRUE))
# Create Map

leaflet(data = BCN_Accomm) %>%
    addProviderTiles("CartoDB.Positron") %>%  
    addHeatmap(
        lng = ~longitude,
        lat = ~latitude,
        intensity = ~price,
        blur = 25,       
        max = 0.03,          
        radius = 15    
    ) %>%
    addMarkers(
        data = neighborhood_means,
        ~longitude, ~latitude,
        popup = ~paste(
            "<strong>Neighborhood:</strong>", neighbourhood,
            "<br><strong>Mean Price (€):</strong>", round(mean_price, 2)
        )
    ) %>%
    addLegend(
        "bottomright",
        pal = colorNumeric("viridis", BCN_Accomm$price),
        values = BCN_Accomm$price,
        title = "Price (€)",
        opacity = 0.7
    )

```

## 4.3 Review Score Rating vs. Price by Room Type

```{r Review Score Rating vs. Price by Room Type, echo = FALSE, warning=FALSE}
#display.brewer.all() #Visualize color palette
ggplot(BCN_Accomm, aes(x = review_scores_rating, y = price, color = room_type)) +
  geom_point(alpha = 0.6) + 
  #scale_color_brewer(palette = "Set2") +
  labs(title = "Scatter Plot of Review Score Rating vs. Price by Room Type",
       x = "Review Score Rating",
       y = "Price",
       color = "Room Type") + 
  theme_minimal()

```

From the plot above, the following insights can be derived:
- The majority of listings are concentrated at the lower price range (below 2000 USD), irrespective of room type.
- Accommodations with high review scores (exceeding 90) are distributed across all price categories, indicating that well-reviewed Airbnbs are not restricted to a particular room type or price range.

# 5 Machine Learning Models

## 5.1 Linear Model
It is used to analyse  .... and answer the project question x
- Accurancy
- Precision
- Recall
- RMSE (Root Mean Squared Error)
- MAE (Mean Absolute Error)
- R Squared

## 5.2 Generalised Linear Model with family set to Poisson
It is used to analyse  .... and answer the project question x
- Accurancy
- Precision
- Recall
- RMSE (Root Mean Squared Error)
- MAE (Mean Absolute Error)
- R Squared

## 5.3 Generalised Linear Model with family set to Binomial
It is used to analyse  .... and answer the project question x
- Accurancy
- Precision
- Recall
- RMSE (Root Mean Squared Error)
- MAE (Mean Absolute Error)
- R Squared

## 5.4 Generalised Additive Model
In this chapter, Generalized Additive Models (GAMs) will be applied with the Price variable as the response, to analyze its interactions with the predictor variables.

The first goal is to identify key factors influencing prices in Barcelona, addressing Research Question 1.

First, we aim to determine whether a nonlinear relationship exists between the independent variables and price. To explore this, the variable Review Score Rating will be plotted against Price to visualize whether the relationship is linear or not.

```{r Price Vs Number of Bedrooms, echo=FALSE}
# Bedrooms vs Price
ggplot(BCN_Accomm, aes(x = review_scores_rating, y = price)) +
  geom_point(color = "blue") +
  geom_smooth(method = "loess", color = "red") + # Loess: on-parametric method for fitting a curve to the data.
  labs(title = "Price vs Review Score Ratings", x = "Review Score Rating", y = "Price")+
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"))
```

From the plot above and Chapter 4.3 of this report, we observe that many points are concentrated on the right side, where higher review scores are paired with lower prices. This suggests a lack of a strong relationship between Review Score Ratings and Price.

Given that at least one variable does not exhibit a linear relationship, we will proceed with applying a Generalized Additive Model (GAM) to better capture potential nonlinear interactions.

Next, the variables Room Type and Host is Super Host will be converted into factors to ensure they are treated as categorical variables in the analysis.

```{r convert factors}
# Covert the categorical as a Factor and not incluide missing values
data_cleaned <- BCN_Accomm %>%
  filter(!is.na(price), !is.na(latitude), !is.na(longitude), !is.na(room_type), !is.na(bedrooms), !is.na(bathrooms)) %>% # Not include Missing Values
  mutate(
    room_type = as.factor(room_type),             # Convert room_type to a factor
    host_is_superhost = as.factor(host_is_superhost)  # Convert host_is_superhost to a factor
  )
```

The first GAM will be a simple model using latitude, longitude, and review score rating as predictors, each fitted with smoothers to capture potential nonlinear relationships. 

Latitude and longitude are included in the model since the location of an Airbnb is expected to impact the rental price. Similarly, feedback from previous clients, reflected in the review score rating, is considered an important factor influencing price.

$$
Price = \beta_0 + f_1(latitude, longitude) + f_2(review\_scores\_rating)  + \epsilon
$$
```{r Model_Gam, echo=FALSE, warning=FALSE}
# Fit a GAM
model_gam <- gam(price ~ s(latitude, longitude) + s(review_scores_rating),
                 data = data_cleaned)

# Summarize the model
summary(model_gam)

```

From the model, we can derive the following insights:

## Insights from the First Model

### **Parametric Coefficients**
- The baseline price of an Airbnb is **127.964 Euros** (\( B_0 \)), representing the baseline price before accounting for other factors.
  - This value is adjusted based on the property's specific location (latitude and longitude) and the feedback provided by users (Review Score Rating).

### **Smooth Term for Latitude and Longitude**
- **Effective Degrees of Freedom (edf):**  
  - Equal to **25.5**, indicating a highly complex **non-linear relationship** between latitude/longitude and price.
- **P-value:**  
  - \( < 2e-16 \), suggesting that the smooth term is **highly significant**, and there is a strong relationship with price.

### **Smooth Term for Review Score Rating**
- **Effective Degrees of Freedom (edf):**  
  - Equal to **7.4**, also showing a **non-linear relationship** with price, though less strong than latitude/longitude.
- **P-value:**  
  - \( < 2e-16 \), indicating that the smooth term is **highly significant**, and there is a strong relationship with price.

### **Model Performance**
- The **R-squared value** is quite low (**2.54%**), suggesting that other important variables influencing Airbnb prices might be missing from the model.

```{r}
# Plot f(review_scores_rating) vs. Price
plot_review_scores <- ggplot(data_cleaned, aes(x = review_scores_rating, y = price)) +
  stat_smooth(method = "gam", color = "red", formula = y ~ s(x, k = 5)) +  # Smooth line for review scores
  geom_point(aes(color = price)) +  # Points with color based on price
  labs(title = "Price vs. Review Score Rating", x = "Review Score Rating", y = "Price") +
  theme_minimal()

print(plot_review_scores)
```

---

## Improvements for the Second Model

- The **Room Type** variable will be added as a smooth term to capture differences in price based on the type of listing.
- Additionally, the **interaction between latitude and longitude, grouped by Room Type**, will be incorporated. 
  - This enhancement accounts for the fact that the price of a listing can vary based on its **location** and the **type of room offered**.



$$
Price = \beta_0 + f_1(latitude, longitude \,|\, room\_type) + f_2(review\_scores\_rating) + \beta_1(room\_type) + \epsilon
$$
```{r Model_gam_2, echo=FALSE, warning=FALSE}
model_gam_2 <- gam(price ~ s(latitude, longitude, by = room_type) + s(review_scores_rating) + room_type,
                         data = data_cleaned)

summary(model_gam_2)
```

From the second model, we can derive the following insights:

## Insights from the Second Model

### **Parametric Coefficients**
- **Baseline Price (Intercept):**  
  - The baseline price of an Airbnb is **169.740 Euros** (\( B_0 \)), representing the baseline price for an Entire Home/Apt before accounting for latitude/longitude and Review Score Rating factors.
  - This value is adjusted based on the property's specific location (latitude and longitude) and the feedback provided by users (Review Score Rating).
- **Room Type: Private Room:**  
  - The coefficient is **-90.287**, meaning Airbnbs classified as Private Rooms are, on average, **90 Euros cheaper** than Entire Homes/Apts.
  - The **p-value (< 2e-16)** shows that this difference is statistically significant.
- **Room Type: Shared Room:**  
  - The coefficient is **-39.019**, meaning Shared Rooms are, on average, **39 Euros cheaper** than Entire Homes/Apts.
  - However, the **p-value (0.655)** suggests that this difference is **not statistically significant**.

### **Smooth Term for Latitude and Longitude**
- **Effective Degrees of Freedom (edf):**  
  - Varies from **16.12 to 25.44**, indicating a **non-linear relationship** between location and price, depending on the room type.
- **P-Values:**  
  - The smooth terms for **Entire Home/Apt** and **Shared Room** are **highly significant** (\( p < 2e-16 \)).
  - For **Private Room**, the effect is less significant (\( p = 0.0013 \)).

### **Smooth Term for Review Score Rating**
- **Effective Degrees of Freedom (edf):**  
  - Equal to **7.28**, showing a **non-linear relationship** with price, though less strong compared to latitude/longitude.
- **P-Value:**  
  - The smooth term is **highly significant** (\( p < 2e-16 \)), indicating a strong relationship with price.

### **Model Performance**
- The **R-squared value (7.79%)** is much better than the first GAM, suggesting that the model explains more variability in Airbnb prices.
- However, this also indicates that **other important variables** influencing Airbnb prices might still be missing from the model.

$$
Price = \beta_0 + f_1(latitude, longitude) + f_2(review\_scores\_rating) + f_3(bathrooms) + f_4(bedrooms) + \beta_1(room\_type) + \beta_2(host\_is\_superhost) + \epsilon
$$
```{r Model_gam_3, echo=FALSE, warning=FALSE}
model_gam_3 <- gam(price ~ s(latitude, longitude) + s(review_scores_rating) + s(bathrooms) + s(bedrooms) + room_type + host_is_superhost,
                         data = data_cleaned)

summary(model_gam_3)
```




## 5.5 Neural Network
It is used to analyse  .... and answer the project question x
- Accurancy
- Precision
- Recall
- RMSE (Root Mean Squared Error)
- MAE (Mean Absolute Error)
- R Squared

## 5.6 Support Vector Machine
It is used to analyse  .... and answer the project question x
- Accurancy
- Precision
- Recall
- RMSE (Root Mean Squared Error)
- MAE (Mean Absolute Error)
- R Squared

## 5.7 Models comparison and evaluation (after models completed)
- Accurancy
- Precision
- Recall
- RMSE (Root Mean Squared Error)
- MAE (Mean Absolute Error)
- R Squared

# 6. Use of Generative AI (notes from everyone to collect and formulate)
– how you used generative AI in redacting the group work (code-related questions,
generate text, explain concepts…)
– what was easy/hard/impossible to do with generative AI
– what you had to pay attention to/be critical about when using the results obtained
through the use of generative AI

# 7. Conclusions (together at the end)
- Summary of key insights
- Predictive Model Performance (can we answer our research questions?)
- Implications
- Limitations
- Future work 

# 8. Appendix (CR)
Table with the description of every variable and the type

# 9. References 
- website
- literature


